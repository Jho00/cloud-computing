# Идемпотентность POST-запроса
Идемпоте́нтность — свойство объекта или операции при повторном применении операции к объекту давать тот же результат, что и при первом.

```
∀x : f(f(x)) = f(x)
```
Метод HTTP является идемпотентным, если повторный идентичный запрос, сделанный один или несколько раз подряд, имеет один и тот же эффект, не изменяющий состояние сервера. Другими словами, идемпотентный метод не должен иметь никаких побочных эффектов (side-effects), кроме сбора статистики или подобных операций. Корректно реализованные методы GET, HEAD, PUT и DELETE идемпотентны, но не метод POST.

Для того, чтобы реализовать идемпотентный POST-метод клиент генерирует случайный ключ, отправляемый в query параметрах или заголовках. На основе него сервер может решить, был ли уже запрос отправлен или нет

### Методические материалы 

Для того, чтобы реализовать базовый пример идемпотентности нужно к POST-запросу добавить ключ

```http request
POST localhost:8080/api/todo?idempotencyKey=0e3b7e00-f241-11ee-96b0-0800200c9a66
```

Небходимо реализовать сервис, выполняющий CRUD операции над любой сущностью. Например, todo-лист

Пример сущности
```json
{
  "text": "todo 1",
  "description": "Lorem ipsum"
}
```

Рядом, прям в модели сущности, можно хранить ключ идемпотентности (не является стандартом, просто учебный пример).
При создани делать поиск по ключу идемпотентности, если такого ключа нет, то создавать сущность. Если ключ есть, то выбрасывать ощибку

```
public Todo createTodo(TodoDto todoDto, String idempotencyKey) {
    if (todoRepository.findByIdempotencyKey(idempotencyKey) != null) {
        throw new RuntimeException();
    }
    
    return todoRepository.save(todoDto);
}
```

### Дополнительный материал для чтения
- https://developer.mozilla.org/ru/docs/Glossary/Idempotent
- https://habr.com/ru/companies/domclick/articles/779872/