# Service Discovery
Service Discovery  для распределенных систем

Как отследить расположение сервисов и их доступность в динамической сети? Выход – системы обнаружения сервисов

Времена простых статичных конфигураций подходят к концу. Сегодня в тренде облачные сервисы, виртуализация, микроархитектура, распределенные системы. Все это по мере запуска новых систем становится все сложнее и сложнее.

В итоге остро стоит вопрос о возможностях динамической конфигурации систем и обнаружении сервисов «на лету». Серверы могут перемещаться между ЦОД, меняя IP, контейнеры включаются и отключаются, сервисы стартуют и пропадают, один и тот же порт могут использовать разные приложения. Все эти изменения необходимо отслеживать как можно раньше, но традиционные инструменты мало подходят для решения этих задач.

Можно эту задачу автоматизировать с помощью скриптов, отслеживая свой и чужой IP, настроить службу DNS, использовать прокси и т.д. При небольшом количестве и в более-менее статичной среде это работает, но по мере увеличения систем управлять всем этим становится сложнее. Будут возникать задержки в случае неработы службы и необходимости быстрого подключения к другому серверу.

Проблема нашла решение в специальном классе приложений – системы обнаружения сервисов (Service Discovery).

#### Задача Service Discovery

Системы обнаружения сервисов представляют собой базу данных, содержащих актуальную информацию о расположении и состоянии экземпляров службы, позволяющую, таким образом, автоматизировать процесс получения ответа на вопрос, на каком IP запущен нужный сервис, анонсировать в сети новый ресурс или быстро изменить настройки в случае неответа определенного приложения.

Работает такая схема очень просто. Вся процедура состоит из двух фаз: регистрация сервиса (Service Registration) и обнаружение сервиса (Service Discovery).

Запустившись, сервер, контейнер или виртуальная машина с помощью настроенного агента отсылают информацию в центральный реестр о том, какие сервисы обеспечивает. Опционально могут быть указаны порт, протоколы, версии, данные для аутентификации, параметры окружения, вспомогательные теги и в принципе любая другая информация.

Теперь любой клиент может обратиться к хранилищу с запросом, используя API или традиционные службы вроде DNS, и получить нужную информацию. То есть, грубо говоря, Service Discovery – это аналог DNS для распределенных сетей с часто меняющейся конфигурацией.

Кроме хранения данных, центральный сервер обычно отслеживает состояние сервисов и отмечает те, которые не отвечают на запросы. Если сервис сообщает, что он отключается, онавтоматически удаляется из каталога. Еще одна полезная функция – балансировка нагрузки между одинаковыми сервисами за счет выдачи разным клиентам разных IP. Также такие сервисы используются для хранения конфигураций с возможностью отслеживания изменений значения параметра.

К слову, в Windows Server 2016 в Microsoft, в котором возможно использование контейнеров, для обнаружения служб не будет каких-либо встроенных инструментов, поэтому придется использовать сторонние разработки.

Материал взят [отсюда](https://samag.ru/archive/article/3208)

### Методические материалы
Необходимо разработать наивный ServiceDiscovery, который умеет регистрировать информацию о сервисах и регулярно опрашивать их состояние.

1. Нужно создать базовый сервис, который будет подниматься и представлять из себя рабочую ноду. В этом сервисе достаточно сделать всего одни endpoint

```http request
GET localhost:8080/api/health
```
2. Необходимо разработать экземпляр Service Discovery - его задача содержать информацию о работающих серверах. Service Discovery имеет всего 2 endpoint

```http request
POST localhost:3000/api/register
```
При обработке этого вызова Service Discovery получают информацию о сервере (в частности - его хост и порт) и сохраняет в своем локальном хранилище. В качестве локальноного хранилища можно использовать оперативную память

```http request
GET localhost:3000/api/list
```
При обработке этого вызова Service Discovery выдают актуальную информацию о работающих серверах

3. При старте обычной ноды она должна отправлять запрос в Service Discovery с информацией о себе.
4. Раз в N секунд (задавать в конфиге) Service Discovery должен опрашивать ноды с целью проверки их работоспособности (отправлять запрос на /health). При получении 500 необходимо убирать ноду из списка актуальных


### Дополнительный материал для чтения
- https://habr.com/ru/articles/487706/
- https://www.nginx.com/blog/service-discovery-in-a-microservices-architecture/
- https://microservices.io/patterns/server-side-discovery.html